language: php
services: docker

php:
  - '5.6'
  - '7.1'
  - '7.2'

env:
  - VERSION=1.7.2.2
    CHANNEL=major
    TEST_TYPE=from_channel
  - VERSION=1.6
    CHANNEL=major
    TEST_TYPE=from_channel
  - VERSION=1.6.1.10
    CHANNEL=minor
    TEST_TYPE=from_channel
  # Check how the upgrade behaves with the latest stable PrestaShop release
  - VERSION=latest
    CHANNEL=minor
    TEST_TYPE=from_channel
  # Check how the upgrade behaves with the latest pre-release PrestaShop version
  - VERSION=latest
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  # Check MULTIPLE SETUPS to 1.7.7.0
  - VERSION=1.7.0.0
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.1.0
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.2.0
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.3.0
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.4.0
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.4.2
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.4.4
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.5.0
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.5.2
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.6.0
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.6.5
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x
  - VERSION=1.7.6.8
    CHANNEL=archive
    TEST_TYPE=from_archive
    PS_TARGET_VERSION=1.7.7.0
    PS_TARGET_BRANCH=1.7.7.x

cache:
  directories:
    - $HOME/.composer/cache

install:
  - composer install
  - if [ "$TEST_TYPE" == "from_archive" ]; then
      bash tests/downloadNightlyZip.sh;
    fi
  - docker-compose up -d

before_script:
  - bash -c 'while [[ "$(curl -L -s -o /dev/null -w %{http_code} http://localhost:8001/index.php)" != "200" ]]; do sleep 5; done'
  - docker exec -u www-data -ti prestashop_autoupgrade cp modules/autoupgrade/ -R admin-dev
  - if [ "$TEST_TYPE" == "from_archive" ]; then
      docker exec -u www-data -ti prestashop_autoupgrade mkdir admin-dev/autoupgrade/download;
      docker exec -u www-data -ti prestashop_autoupgrade mv modules/autoupgrade/prestashop.zip admin-dev/autoupgrade/download/prestashop.zip;
      docker exec -u www-data -ti prestashop_autoupgrade php admin-dev/autoupgrade/cli-updateconfig.php --from=admin-dev/autoupgrade/tests/fixtures/archive_config_file.json --dir=admin-dev;
    fi

script:
  # Upgrade
  - docker exec -u www-data -ti prestashop_autoupgrade php modules/autoupgrade/tests/testCliProcess.php admin-dev/autoupgrade/cli-upgrade.php  --dir="admin-dev" --channel="$CHANNEL"
  # Front office -> HTTP code 200 expected (no maintenance)
  - bash -c '[ "$(curl -L -s -o /dev/null -w %{http_code} http://localhost:8001/index.php)" == "200" ]'
  # Back office -> HTTP code 200 expected
  - bash -c '[ "$(curl -L -s -o /dev/null -w %{http_code} http://localhost:8001/admin-dev/index.php)" == "200" ]'

  # Rollback (only when expect a completed upgrade)
  - if [ $VERSION != "latest" ]; then
      docker exec -u www-data -ti prestashop_autoupgrade php modules/autoupgrade/tests/testCliProcess.php admin-dev/autoupgrade/cli-rollback.php  --dir="admin-dev" --backup=`docker exec -ti prestashop_autoupgrade bash -c "ls -td -- /var/www/html/admin-dev/autoupgrade/backup/*/ | head -n 1 | cut -d'/' -f8 | tr -d '\n'"`;
    fi
  # Front office -> HTTP code 200 expected (no maintenance)
  - bash -c '[ "$(curl -L -s -o /dev/null -w %{http_code} http://localhost:8001/index.php)" == "200" ]'
  # Back office -> HTTP code 200 expected
  - bash -c '[ "$(curl -L -s -o /dev/null -w %{http_code} http://localhost:8001/admin-dev/index.php)" == "200" ]'

after_script:
  - docker ps
  - docker logs prestashop_autoupgrade
